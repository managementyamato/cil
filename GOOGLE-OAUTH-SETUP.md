# Googleアカウントログイン設定ガイド

## 1. Google Cloud Platformでの準備

### ステップ1: Google Cloud Consoleにアクセス
1. https://console.cloud.google.com/ にアクセス
2. Googleアカウントでログイン

### ステップ2: プロジェクト作成
1. 画面上部の「プロジェクトを選択」をクリック
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を入力（例: YA管理システム）
4. 「作成」をクリック

### ステップ3: OAuth同意画面の設定
1. 左メニューから「APIとサービス」→「OAuth同意画面」を選択
2. 「外部」を選択して「作成」
3. 以下を入力：
   - **アプリ名**: YA管理一覧
   - **ユーザーサポートメール**: 管理者のメールアドレス
   - **デベロッパーの連絡先情報**: 管理者のメールアドレス
4. 「保存して次へ」

### ステップ4: スコープの追加
1. 「スコープを追加または削除」をクリック
2. 以下のスコープを選択：
   - `.../auth/userinfo.email`
   - `.../auth/userinfo.profile`
   - `openid`
3. 「更新」→「保存して次へ」

### ステップ5: テストユーザーの追加
1. 「テストユーザーを追加」をクリック
2. 使用するGoogleアカウントのメールアドレスを追加
3. 「保存して次へ」

### ステップ6: OAuth 2.0クライアントIDの作成
1. 左メニューから「APIとサービス」→「認証情報」を選択
2. 「認証情報を作成」→「OAuth クライアント ID」をクリック
3. アプリケーションの種類：**ウェブ アプリケーション**
4. 名前：YA管理システム
5. **承認済みのリダイレクト URI**に以下を追加：
   ```
   http://localhost:8000/google-callback.php
   ```
   本番環境の場合：
   ```
   https://your-domain.com/google-callback.php
   ```
6. 「作成」をクリック

### ステップ7: クライアントIDとシークレットを保存
1. 作成後に表示される**クライアントID**と**クライアントシークレット**をコピー
2. このシステムで使用します

## 2. システムでの設定

### google-config.json ファイルを作成

1. `google-config.json.template` を `google-config.json` にコピー
   ```bash
   cp google-config.json.template google-config.json
   ```

2. `google-config.json` を編集して、Google Cloud Consoleから取得した情報を入力
   ```json
   {
     "client_id": "ここにクライアントIDを貼り付け",
     "client_secret": "ここにクライアントシークレットを貼り付け",
     "redirect_uri": "http://localhost:8000/google-callback.php"
   }
   ```

**重要**:
- このファイルは機密情報を含むため、.gitignoreに追加されています
- 本番環境では `redirect_uri` を実際のドメインに変更してください

## 3. 動作の仕組み

1. ユーザーが「Googleでログイン」ボタンをクリック
2. Googleのログイン画面にリダイレクト
3. ユーザーがGoogleアカウントで認証
4. システムにリダイレクトされ、メールアドレスと名前を取得
5. 従業員マスタのメールアドレスと照合
6. 一致すればログイン成功

## 4. セキュリティ設定

### 許可するドメインの制限
特定のドメインのみ許可する場合：
- 会社のGoogleアカウント（@yamato-agency.com など）のみ許可
- コード内で制限可能

### テストユーザー vs 本番公開
- **テストモード**: 登録したテストユーザーのみログイン可能
- **本番公開**: OAuth同意画面を公開申請（Googleの審査が必要）

## 5. 費用

- **無料**: Google OAuth 2.0の使用は無料です
- 制限なし: ログイン回数に制限はありません

## 6. 必要な権限まとめ

✅ **必要な権限**:
- Google Cloud Consoleへのアクセス権（無料Googleアカウントで可）
- プロジェクト作成権限（デフォルトで持っている）

❌ **不要なもの**:
- 有料プラン
- 特別な審査（社内利用のみの場合）
- ドメインの所有権（localhost での開発時）

## 7. 実装の確認

システムに以下のファイルが作成されています：

### 実装済みファイル
- **google-oauth.php**: OAuth認証クライアント（GoogleOAuthClient クラス）
- **google-callback.php**: Googleからのコールバック処理
- **google-config.json.template**: 設定ファイルのテンプレート
- **login.php**: Googleログインボタンが追加済み

### 動作の流れ
1. ユーザーがログイン画面で「Googleでログイン」ボタンをクリック
2. Googleの認証画面にリダイレクト
3. ユーザーがGoogleアカウントで認証
4. `google-callback.php` にリダイレクトされる
5. アクセストークンを取得し、ユーザー情報を取得
6. 従業員マスタのメールアドレスと照合
7. 一致すればログイン成功、ダッシュボードにリダイレクト

## 8. 次のステップ

Google Cloud Consoleでの設定が完了したら：
1. Google Cloud Consoleでプロジェクトを作成
2. OAuth 2.0クライアントIDを作成
3. クライアントIDとシークレットをコピー
4. `google-config.json` を作成して設定を入力
5. テストユーザーを追加（Google Cloud Console）
6. ログインテスト（`http://localhost:8000/login.php`）

## よくある質問

**Q: 会社のGoogleアカウントのみに制限できる？**
A: はい、コード内でメールドメインをチェックして `@yamato-agency.com` のみ許可できます。

**Q: 既存のパスワードログインも残せる？**
A: はい、Googleログインと従来のログインを併用できます。

**Q: 本番環境で使うには審査が必要？**
A: 社内の限られたユーザーのみ（100人未満）なら、テストモードのままで問題ありません。

**Q: 設定を間違えたらどうなる？**
A: ログインできなくなるだけで、データは失われません。設定を修正すれば復旧できます。
