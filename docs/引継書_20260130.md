# YA管理システム 開発引継書

**作成日**: 2026年1月30日
**対象システム**: YA管理一覧（yamato-mgt.com）

---

## 1. システム概要

### 技術スタック
- **バックエンド**: PHP 8.x（XAMPPローカル開発）
- **フロントエンド**: HTML/CSS/JavaScript（フレームワークなし）
- **データストア**: JSON（`data.json`, 各種config/*.json）
- **ホスティング**: XSERVER
- **外部連携**: Google Chat API, Google Drive API, Google Sheets API, MF請求書API

### ディレクトリ構造
```
C:\Claude\master\
├── api/               # API エンドポイント
├── config/            # 設定ファイル（JSON）※git管理外
├── forms/             # フォーム処理
├── functions/         # 共通関数
├── pages/             # 各ページ
├── public_html/       # デプロイ先（FTPアップロード用）
├── scripts/           # 開発・運用スクリプト
├── data.json          # メインデータ ※git管理外
└── style.css          # グローバルスタイル
```

---

## 2. 開発環境セットアップ

### 開発サーバー起動
```batch
scripts\start-dev-server.bat
```
- URL: http://localhost:8000/
- PHP: `C:\xampp\php\php.exe`
- php.iniは `lib/php.ini` を使用

### デプロイ
```powershell
powershell -ExecutionPolicy Bypass -File auto-deploy.ps1
```
- XSERVERへFTP同期（WinSCP使用）
- 自動バックアップ後にアップロード
- `data.json`, `users.json`, 各種設定ファイルは除外

---

## 3. 主要機能一覧

| ページ | ファイル | 概要 |
|--------|----------|------|
| ダッシュボード | `pages/index.php` | トラブル・資金状況サマリ |
| トラブル対応 | `pages/troubles.php` | トラブル一覧・モーダル編集・一括変更 |
| アルコールチェック | `pages/photo-attendance.php` | Chat同期・写真管理・CSV出力 |
| 財務 | `pages/finance.php` | 資金繰り・MF請求書連携 |
| 借入金管理 | `pages/loans.php` | Google Sheets連携・一括照合 |
| 損益計算 | `pages/profit-loss.php` | 月次・年度損益 |
| 給与仕訳 | `pages/payroll-journal.php` | 給与データ処理 |
| マスタ管理 | `pages/master.php` | 案件マスタ |
| 従業員マスタ | `pages/employees.php` | 従業員情報・Chat User ID |
| 設定 | `pages/settings.php` | 各種設定 |

---

## 4. セキュリティ実装（重要）

### CSRF保護
すべてのPOSTフォームに必須。

**HTMLフォーム:**
```php
<form method="POST">
    <?= csrfTokenField() ?>
    <!-- フォーム内容 -->
</form>
```

**PHP側:**
```php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    verifyCsrfToken();
}
```

**JavaScript fetch:**
```javascript
const csrfToken = '<?= generateCsrfToken() ?>';
fetch('/api/xxx.php', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
    },
    body: JSON.stringify(data)
});
```

### ファイルロック
JSONファイルの読み書きには必ずファイルロックを使用。
- `getData()` / `saveData()` は内部でロック済み
- 個別実装時: 読み込み `LOCK_SH`、書き込み `LOCK_EX`

### 権限管理
- `canEdit()`: 編集権限チェック
- `isAdmin()`: 管理者権限チェック
- `api/auth.php` の `$defaultPagePermissions` でページ別権限定義

---

## 5. 最近の主要変更（2026年1月）

### トラブル対応ページ（troubles.php）
1. **モーダル編集機能追加**
   - 別ページ遷移からモーダル編集に変更
   - `openEditModal()` / `closeEditModal()` JavaScript関数
   - POST処理: `modal_edit` パラメータで判定

2. **PJ番号検索バー**
   - フィルターモーダルから独立
   - テーブル上部に常時表示

3. **記入者・対応者ドロップダウン修正**
   - インポートされた名前も選択可能に
   - `$allReporters` / `$allResponders` 配列でマージ

### PJ番号正規化（sync-troubles.php）
- 小文字から**大文字に統一**変更
- `strtoupper($pj)` で `P153` 形式に統一

### トラブル登録フォーム（trouble-bulk-form.php）
- **コンパクト化**実施
- 5列グリッドレイアウト
- パディング・フォントサイズ縮小

### アルコールチェック（photo-attendance.php）
- **その日に同期された従業員のみ対象表示**
- `getAlcoholCheckTargetEmployeesForDate($date)` 関数追加
- 対象者がいない場合のガイダンスメッセージ表示

### Google Chat連携
- メールアドレスによる従業員自動紐づけ機能追加
- `chat_user_id` フィールドで手動紐づけも可能

---

## 6. 外部API連携

### Google Chat API
- **設定**: `config/google-config.json`
- **用途**: アルコールチェック写真取得
- **エンドポイント**: `api/google-chat.php`

### Google Drive API
- **設定**: `config/google-config.json`
- **用途**: ファイルアップロード・管理
- **エンドポイント**: `api/google-drive.php`

### Google Sheets API
- **設定**: `config/integration-config.json`
- **用途**: 借入金データ同期、トラブルデータ同期
- **エンドポイント**: `api/google-sheets.php`

### MF請求書API
- **設定**: `config/mf-config.json`
- **用途**: 請求書ステータス取得
- **エンドポイント**: `api/mf-api.php`

---

## 7. データ構造

### data.json 主要キー
```json
{
  "employees": [...],      // 従業員マスタ
  "projects": [...],       // 案件マスタ
  "troubles": [...],       // トラブル対応
  "loans": [...],          // 借入金
  "no_car_usage": [...]    // 車不使用申請
}
```

### troubles配列の構造
```json
{
  "id": 123,
  "pj_number": "P153",
  "trouble_content": "内容",
  "response_content": "対応内容",
  "prevention_notes": "再発防止策",
  "reporter": "記入者名",
  "responder": "対応者名",
  "status": "未対応|対応中|保留|完了",
  "date": "2026/01/30",
  "deadline": "2026-02-15",
  "call_no": "26013001",
  "case_no": "T1",
  "company_name": "会社名",
  "customer_name": "顧客名",
  "honorific": "様",
  "project_contact": false,
  "created_at": "2026-01-30 10:00:00",
  "updated_at": "2026-01-30 10:00:00"
}
```

---

## 8. 注意事項

### 新ページ追加時のチェックリスト
1. `api/auth.php` の `$defaultPagePermissions` に権限追加
2. `functions/header.php` のサイドバーにリンク追加
3. POSTフォームがあればCSRF保護を入れる

### 禁止事項
- `data.json` を直接編集しない（必ず `getData()` / `saveData()` 経由）
- 機密ファイルをgitにコミットしない（`config/*.json`, `*.key`, `data.json`）
- HTMLへの出力は必ず `htmlspecialchars()` でエスケープ

### トラブルシューティング
- **デプロイ失敗**: `deploy.log` を確認
- **権限エラー**: `$_SESSION['user_id']` とページ権限設定を確認
- **データ破損**: `backups/` フォルダから復元可能

---

## 9. 連絡先・参考資料

- **本番サイト**: https://yamato-mgt.com/
- **CLAUDE.md**: プロジェクトルートに開発ガイドライン記載
- **監査ログ**: `pages/audit-log.php` で操作履歴確認可能
