# API連携 設定ガイド

外部システム（基幹システム等）とYA管理システムを連携するための設定手順です。

## 1. API連携を有効化する

1. 管理者アカウントでログイン
2. サイドバーから「API連携設定」を開く
3. 「API連携」の「有効にする」ボタンをクリック

## 2. APIキーを発行する

1. 「APIキー管理」セクションで、キー名を入力
   - 例: `基幹システム連携`、`外部連携用`
2. 「新しいキーを生成」をクリック
3. 生成されたAPIキーをコピーして安全な場所に保管

> **重要**: APIキーは一度しか表示されません。紛失した場合は新しいキーを発行してください。

## 3. IP制限を設定する（任意）

セキュリティを強化するため、アクセス元IPを制限できます。

1. 「許可IPアドレス」セクションでIPアドレスを入力
2. 「追加」をクリック

> IPを設定しない場合は、全てのIPからのアクセスを許可します。

## 4. 外部システム側の設定

外部システムから以下の情報でAPIを呼び出します。

### エンドポイント

| API | URL |
|-----|-----|
| 案件API | `https://あなたのドメイン/api/integration/projects.php` |
| 顧客API | `https://あなたのドメイン/api/integration/customers.php` |

### 必須ヘッダー

```
Content-Type: application/json
X-Api-Key: 発行したAPIキー
```

## 5. 動作確認

### curlでテスト

```bash
# 案件一覧を取得
curl -X GET "https://あなたのドメイン/api/integration/projects.php" \
  -H "X-Api-Key: YOUR_API_KEY"

# 案件を登録
curl -X POST "https://あなたのドメイン/api/integration/projects.php" \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: YOUR_API_KEY" \
  -d '{"name": "テスト案件", "external_id": "TEST-001"}'
```

### 成功レスポンス例

```json
{
  "success": true,
  "message": "案件を登録しました",
  "data": {
    "action": "created",
    "id": "pj_20260121120000_a1b2",
    "external_id": "TEST-001"
  }
}
```

## 6. ログの確認

API呼び出しの履歴は「API連携設定」の「ログ」タブで確認できます。

- リクエスト日時
- 実行されたアクション
- 使用されたAPIキー
- アクセス元IP
- 処理結果

## トラブルシューティング

### 「API連携が無効です」エラー

→ 管理画面でAPI連携を「有効」にしてください

### 「無効なAPIキーです」エラー

→ APIキーが正しいか確認してください
→ APIキーが「有効」状態か確認してください

### 「許可されていないIPアドレスです」エラー

→ アクセス元IPが許可リストに含まれているか確認してください
→ または、許可IPリストを空にして全IP許可にしてください

### 「案件名は必須です」エラー

→ リクエストボディに`name`フィールドを含めてください

## データの更新ルール

- `external_id`（外部システムのID）で既存データを検索
- 同じ`external_id`があれば更新、なければ新規作成
- `external_id`を指定しない場合は常に新規作成

## セキュリティ推奨事項

1. **本番環境ではIP制限を設定** - 信頼できるIPのみ許可
2. **APIキーは定期的に更新** - 古いキーは無効化
3. **ログを定期的に確認** - 不正アクセスがないかチェック
4. **HTTPSを使用** - 通信を暗号化

## 関連ドキュメント

- [API仕様書](./API-SPEC.md) - 詳細なAPI仕様
