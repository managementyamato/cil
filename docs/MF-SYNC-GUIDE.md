# MF請求書同期ガイド

## 概要

マネーフォワードクラウド請求書（MF）とシステムの請求書データを同期する手順です。

## 同期の仕組み

### 通常の同期
- 指定した月のMF請求書を取得
- 新規請求書を追加
- 既存請求書はスキップ
- **MFで削除された請求書は自動的に削除**（同期対象期間内のみ）

### 削除の動作
- 同期実行時に、MFに存在しない請求書を検知
- 同期対象期間内の請求書のみが削除対象
- 期間外の請求書は影響を受けない

## 同期手順

### 1. 月別同期（通常）

1. 入金管理ページ（`/pages/finance.php`）にアクセス
2. 「MFから同期」ボタンをクリック
3. 同期する月を選択（クイック選択ボタンまたはカレンダー）
4. 「同期開始」をクリック

### 2. データクリア（リセット）

MFとデータが合わない場合、一度クリアして再同期することで解決できます。

1. 入金管理ページにアクセス
2. 「MFから同期」ボタンをクリック
3. 「データクリア」ボタンをクリック（管理者のみ表示）
4. 確認ダイアログで「OK」
5. 全データがクリアされる
6. 必要な月を順番に再同期

## トラブルシューティング

### 金額が合わない場合

**原因**: 過去にMFで削除された請求書がシステムに残っている

**解決方法**:
1. 「データクリア」で全削除
2. 必要な月を再同期

### 同期エラーが発生する場合

1. MF認証が有効か確認（設定 > MF設定）
2. アクセストークンの有効期限を確認
3. 必要に応じて再認証

## API仕様

### 同期API
- エンドポイント: `POST /api/sync-invoices.php`
- パラメータ: `target_month` (YYYY-MM形式)
- レスポンス:
  ```json
  {
    "success": true,
    "message": "2026年2月の請求書を同期: 新規10件、既存5件、削除2件",
    "synced": 15,
    "new": 10,
    "skip": 5,
    "deleted": 2,
    "period": {"from": "2026-02-01", "to": "2026-02-28"}
  }
  ```

### クリアAPI
- エンドポイント: `POST /api/clear-mf-invoices.php`
- 権限: 管理者のみ
- レスポンス:
  ```json
  {
    "success": true,
    "message": "MF請求書データをクリアしました（1000件削除）",
    "deleted": 1000
  }
  ```

## 注意事項

- データクリアは元に戻せません
- クリア後は必ず再同期を行ってください
- 大量のデータを同期する場合は時間がかかることがあります
